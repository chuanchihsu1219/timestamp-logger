<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Timestamp Logger</title>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; background: #f4f4f4; }
    .screen { display: none; }
    .active { display: block; }
    #logButton {
      width: 200px; height: 200px; border-radius: 100px;
      background-color: #3498db; color: white; font-size: 20px; border: none;
      margin: 2em auto; display: block;
    }
    #exportBtn {
      position: absolute; top: 1em; left: 1em;
      background: #2ecc71; color: white; border: none; padding: 10px;
    }
    #logList { margin-top: 2em; text-align: left; max-height: 200px; overflow-y: auto; background: #fff; padding: 1em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="setupScreen" class="screen active">
    <h2>輸入活動名稱</h2>
    <input id="eventName" placeholder="例如：101人流觀察"><br><br>
    <button onclick="startLogging()">開始紀錄</button>
  </div>

  <div id="logScreen" class="screen">
    <button id="exportBtn" onclick="exportCSV()">匯出</button>
    <h2 id="title"></h2>
    <button id="logButton" onclick="logTimestamp()">打點</button>
    <div id="logList"></div>
  </div>

  <script>
    let timestamps = [];
    let eventName = "";

    function startLogging() {
      eventName = document.getElementById("eventName").value || "Event";
      document.getElementById("setupScreen").classList.remove("active");
      document.getElementById("logScreen").classList.add("active");
      document.getElementById("title").innerText = eventName;

      // 如果之前有 localStorage 紀錄就載入
      const saved = localStorage.getItem("timestamps");
      if (saved) {
        timestamps = JSON.parse(saved);
        updateLogList();
      }
    }

    function logTimestamp() {
      const now = new Date();
      const timestamp = now.toISOString();
      timestamps.push(timestamp);
      localStorage.setItem("timestamps", JSON.stringify(timestamps));
      updateLogList();
    }

    function updateLogList() {
      const div = document.getElementById("logList");
      div.innerHTML = "<b>已紀錄時間：</b><br>" + timestamps.map(t => `- ${t}`).join("<br>");
    }

    function exportCSV() {
      const header = "Timestamp\n";
      const body = timestamps.join("\n");
      const content = header + body;

      const now = new Date();
      const formattedDate = now.toISOString().replace(/[:T]/g, "-").split(".")[0];
      const filename = `${eventName}_${formattedDate}.csv`;

      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();

      // 清除 localStorage，重設
      localStorage.removeItem("timestamps");
      timestamps = [];
      updateLogList();
    }

    window.onbeforeunload = function () {
      if (timestamps.length > 0) return "你尚未匯出資料，確定要離開？";
    }
  </script>
</body>
</html>
